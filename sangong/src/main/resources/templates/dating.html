<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>learn Resources</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <link rel="stylesheet" href="../static/css/windows.css" th:href="@{/static/css/windows.css}"/>
  <script type="text/javascript"   th:src="@{/static/js/windows.js}"></script>
  <script type="text/javascript"   th:src="@{/static/js/room.js}"></script>
  <script type="text/javascript"   th:src="@{/static/js/request.js}"></script>
</head>
<body>

  <div id="recharge" class="white_content">
    <table>
      <tr>
        <td><input id="coin" name="coin" value="" type="text"/></td>
      </tr>
      <tr>
        <td>
          <button onclick="closeDialog('recharge')">取消</button>
        </td>
        <td>
          <button onclick="recharge()">确认</button>
        </td>
      </tr>
    </table>
  </div>
  <div id="fade" class="black_overlay"></div>

  <div style="background:url(/static/datingnew.png);height:709px;width:1181px;margin: 0 auto;">
    <div style="position: relative;left: 10.5%;top:1.5%;width:100%;height:50px;">
      <span id="name" style="color:#becdd4;" th:text="'姓名：' + ${peopleInfo.name}"></span>
      <br/>
      <span id="coinShow" style="color:#bdaa35;" th:text="'金币：' + ${peopleInfo.coin}"></span>
    </div>
    <div style="position: relative;left: 1%;top:81%;width:100%;height:79px;">
      <div style="float: left;width:18%;height:100%;">
        <form action="/v1/door/log-out">
          <button style="background-image: url('/static/button.png');" type="submit">退出</button>
        </form>
      </div>
      <div style="float: left;width:1%;height:100%;">
      </div>
      <div style="float: left;width:18.2%;height:100%;">
        <button style="background-image: url('/static/button.png');" onclick="openDialog('recharge')">充值</button>
      </div>
      <div style="float: left;width:1%;height:100%;">
      </div>
      <div style="float: left;width:21.5%;height:100%;">
        <form action="/v1/door/create-room">
          <button style="background-image: url('/static/button.png');" type="submit">快速开始</button>
        </form>
      </div>
      <div style="float: left;width:1%;height:100%;">
      </div>
      <div style="float: left;width:18%;height:100%;">
        <form action="/v1/door/create-room">
          <button style="background-image: url('/static/button.png');" type="submit">创建房间</button>
        </form>
      </div>
    </div>
  </div>
</body>

<script type="text/javascript">
    var websocket = null;

    //判断当前浏览器是否支持WebSocket
    if('WebSocket' in window){
        var token = getToken("nb_token");
        websocket = new WebSocket("ws://127.0.0.1:9095/gamesocket?token="+token);
    }
    else{
        alert('Not support websocket')
    }

     //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
    window.onbeforeunload = function(){
        websocket.close();
    }

    //关闭连接
    function closeWebSocket(){
        websocket.close();
    }

    //解析message
    function parseMessage(message){
      var obj = JSON.parse(message);
      return obj;
    }

    //接收到消息的回调方法
    websocket.onmessage = function(event){
      var message = parseMessage(event.data);
      if(message.messageType == "invite"){
        var truthBeTold = window.confirm("是否加入房间");
        if (truthBeTold) {
          <!--var token = getToken("nb_token");-->
          <!--var str = {"messageType":"add", "roomId":message.roomId,"peopleType":message.peopleType,"token":token}-->
          <!--var strJson = JSON.stringify(str)-->
          <!--websocket.send(strJson);-->

          var str = {'roomId':message.roomId,'peopleType':message.peopleType}
          <!--var strJson = JSON.stringify(str)-->
          doFormRequest("/v1/door/come-in-room","post",str);
        } else{

        }
      }else if(message.messageType == "returnRecharge"){
        document.getElementById('name').innerText="姓名："+message.name;
        document.getElementById('coinShow').innerText="金币："+message.coin;
      }
    }

</script>

</html>
